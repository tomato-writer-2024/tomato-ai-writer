<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•ªèŒ„å°è¯´AIå†™ä½œå·¥å…· - è¶…çº§ç®¡ç†å‘˜ç™»å½•ï¼ˆå¤‡ç”¨ï¼‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #581c87 50%, #1e293b 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 400px;
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
        }

        .logo {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #3b82f6, #9333ea);
            border-radius: 16px;
            margin-bottom: 16px;
        }

        .logo svg {
            width: 32px;
            height: 32px;
            color: white;
        }

        .header h1 {
            color: white;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .header p {
            color: #9ca3af;
            font-size: 14px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 32px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            color: white;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .form-group input::placeholder {
            color: #9ca3af;
        }

        .form-group input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #3b82f6, #9333ea);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
        }

        .btn:hover {
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-alt {
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            margin-top: 12px;
        }

        .btn-alt:hover {
            background: linear-gradient(135deg, #d97706, #dc2626);
        }

        .btn-script {
            background: linear-gradient(135deg, #10b981, #14b8a6);
            margin-top: 12px;
            font-size: 14px;
            padding: 10px;
        }

        .btn-script:hover {
            background: linear-gradient(135deg, #059669, #0d9488);
        }

        .divider {
            margin: 24px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .links {
            text-align: center;
        }

        .links a {
            display: block;
            color: #60a5fa;
            text-decoration: none;
            font-size: 14px;
            margin: 8px 0;
            transition: color 0.2s;
        }

        .links a:hover {
            color: #93c5fd;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: #fca5a5;
        }

        .alert-success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.5);
            color: #86efac;
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.5);
            color: #93c5fd;
            font-size: 12px;
        }

        .browser-info {
            text-align: center;
            margin-top: 24px;
            font-size: 12px;
            color: #6b7280;
        }

        .debug-log {
            margin-top: 16px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #86efac;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .debug-log .log-entry {
            margin: 4px 0;
            padding: 2px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .debug-log .log-error {
            color: #fca5a5;
        }

        .debug-log .log-success {
            color: #86efac;
        }

        .debug-log .log-info {
            color: #93c5fd;
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1e293b;
            border-radius: 16px;
            padding: 24px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-header h3 {
            color: white;
            font-size: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 32px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: white;
        }

        .code-block {
            background: rgba(0, 0, 0, 0.5);
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #86efac;
            overflow-x: auto;
            margin-bottom: 16px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .modal-footer {
            display: flex;
            gap: 8px;
        }

        .modal-footer button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-copy {
            background: #3b82f6;
            color: white;
        }

        .btn-copy:hover {
            background: #2563eb;
        }

        .btn-close {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
            </div>
            <h1>ç•ªèŒ„å°è¯´AIå†™ä½œå·¥å…·</h1>
            <p>è¶…çº§ç®¡ç†å‘˜ç™»å½•ï¼ˆçº¯åŸç”Ÿç‰ˆæœ¬ï¼Œé€‚ç”¨äºæ‰€æœ‰æµè§ˆå™¨ï¼‰</p>
        </div>

        <div class="card">
            <div id="alertContainer"></div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="email">é‚®ç®±</label>
                    <input type="email" id="email" name="email" placeholder="admin@tomato-ai.com" required>
                </div>

                <div class="form-group">
                    <label for="password">å¯†ç </label>
                    <input type="password" id="password" name="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>

                <button type="submit" id="loginBtn" class="btn">ç™»å½•</button>
            </form>

            <div class="divider"></div>

            <button id="autoLoginBtn" class="btn btn-alt">ğŸš€ ä¸€é”®ç™»å½•ï¼ˆè‡ªåŠ¨å°è¯•æ‰€æœ‰æ–¹å¼ï¼‰</button>

            <button id="scriptBtn" class="btn btn-script">ğŸ“ ç”Ÿæˆæ§åˆ¶å°è„šæœ¬ï¼ˆç»ˆææ–¹æ¡ˆï¼‰</button>

            <div class="divider"></div>

            <div class="links">
                <a href="/">â† è¿”å›é¦–é¡µ</a>
                <a href="/admin/login" style="color: #a78bfa;">â† è¿”å›æ ‡å‡†ç™»å½•é¡µ</a>
            </div>
        </div>

        <div class="browser-info" id="browserInfo"></div>

        <div id="debugLogContainer" style="display: none;">
            <button onclick="document.getElementById('debugLog').style.display = document.getElementById('debugLog').style.display === 'none' ? 'block' : 'none'" style="margin-top: 8px; padding: 4px 8px; background: rgba(255,255,255,0.1); border: none; color: #9ca3af; cursor: pointer; font-size: 12px; border-radius: 4px;">
                åˆ‡æ¢è°ƒè¯•æ—¥å¿—
            </button>
            <div id="debugLog" class="debug-log"></div>
        </div>
    </div>

    <!-- è„šæœ¬æ¨¡æ€æ¡† -->
    <div id="scriptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>è‡ªåŠ¨ç™»å½•è„šæœ¬</h3>
                <button class="modal-close" onclick="closeScriptModal()">&times;</button>
            </div>
            <div class="code-block" id="scriptCode"></div>
            <div style="margin-bottom: 16px; font-size: 14px; color: #d1d5db;">
                <p><strong>ä½¿ç”¨è¯´æ˜ï¼š</strong></p>
                <p>1. å¤åˆ¶ä¸Šé¢çš„è„šæœ¬</p>
                <p>2. æŒ‰ <kbd style="padding: 2px 6px; background: rgba(255,255,255,0.2); border-radius: 4px;">F12</kbd> æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°</p>
                <p>3. ç²˜è´´è„šæœ¬å¹¶æŒ‰ <kbd style="padding: 2px 6px; background: rgba(255,255,255,0.2); border-radius: 4px;">Enter</kbd> æ‰§è¡Œ</p>
                <p>4. è‡ªåŠ¨ç™»å½•æˆåŠŸåä¼šè·³è½¬åˆ°ç®¡ç†åå°</p>
                <p style="color: #fbbf24; margin-top: 8px;">æç¤ºï¼šæ­¤è„šæœ¬é€‚ç”¨äºæ‰€æœ‰æµè§ˆå™¨ï¼ŒåŒ…æ‹¬360ã€QQã€Edgeç­‰</p>
            </div>
            <div class="modal-footer">
                <button class="btn-close" onclick="closeScriptModal()">å…³é—­</button>
                <button class="btn-copy" onclick="copyScript()">å¤åˆ¶è„šæœ¬</button>
            </div>
        </div>
    </div>

    <script>
        // æµè§ˆå™¨æ£€æµ‹
        function detectBrowser() {
            const ua = navigator.userAgent;
            let name = 'æœªçŸ¥æµè§ˆå™¨';
            let version = '';

            if (/360SE|360EE|360Browser|QIHU/i.test(ua)) {
                name = '360æµè§ˆå™¨';
                const match = ua.match(/360(?:SE|EE|Browser)[\/\s](\d+\.?\d*)/i);
                version = match ? match[1] : '';
            } else if (/QQBrowser|QQ/i.test(ua)) {
                name = 'QQæµè§ˆå™¨';
                const match = ua.match(/QQBrowser[\/\s](\d+\.?\d*)/i);
                version = match ? match[1] : '';
            } else if (/Sogou/i.test(ua)) {
                name = 'æœç‹—æµè§ˆå™¨';
            } else if (/Edg/i.test(ua)) {
                name = 'Microsoft Edge';
                const match = ua.match(/Edg[\/\s](\d+\.?\d*)/i);
                version = match ? match[1] : '';
            } else if (/Chrome/i.test(ua)) {
                name = 'Chrome';
                const match = ua.match(/Chrome[\/\s](\d+\.?\d*)/i);
                version = match ? match[1] : '';
            } else if (/Firefox/i.test(ua)) {
                name = 'Firefox';
                const match = ua.match(/Firefox[\/\s](\d+\.?\d*)/i);
                version = match ? match[1] : '';
            } else if (/Safari/i.test(ua)) {
                name = 'Safari';
                const match = ua.match(/Version[\/\s](\d+\.?\d*)/i);
                version = match ? match[1] : '';
            }

            return { name, version, ua };
        }

        // æ˜¾ç¤ºæµè§ˆå™¨ä¿¡æ¯
        const browserInfo = detectBrowser();
        document.getElementById('browserInfo').innerHTML = `å½“å‰æµè§ˆå™¨: ${browserInfo.name} ${browserInfo.version}`;

        // è°ƒè¯•æ—¥å¿—
        const debugLogEntries = [];

        function addDebugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = { timestamp, message, type };
            debugLogEntries.push(entry);

            const logContainer = document.getElementById('debugLog');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;

            console.log(`[ç™»å½•è°ƒè¯•] ${message}`);
        }

        function showDebugLog() {
            document.getElementById('debugLogContainer').style.display = 'block';
            document.getElementById('debugLog').style.display = 'block';
        }

        // æ˜¾ç¤ºæç¤º
        function showAlert(message, type = 'error') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // ç™»å½•å‡½æ•°
        async function handleLogin(email, password) {
            showDebugLog();

            try {
                addDebugLog('å¼€å§‹ç™»å½•æµç¨‹', 'info');
                addDebugLog(`æµè§ˆå™¨: ${browserInfo.name} ${browserInfo.version}`, 'info');

                // æ£€æŸ¥localStorage
                try {
                    localStorage.setItem('__test__', 'test');
                    localStorage.removeItem('__test__');
                    addDebugLog('localStorageå¯ç”¨', 'success');
                } catch (e) {
                    addDebugLog('localStorageä¸å¯ç”¨: ' + e.message, 'error');
                    throw new Error('æµè§ˆå™¨ç¦ç”¨äº†æœ¬åœ°å­˜å‚¨ï¼Œè¯·æ£€æŸ¥éšç§æ¨¡å¼æˆ–å®‰å…¨è®¾ç½®');
                }

                // æ­¥éª¤1: è°ƒç”¨ç™»å½•API
                addDebugLog('æ­¥éª¤1: è°ƒç”¨ç™»å½•API', 'info');

                const loginResp = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password }),
                    credentials: 'include'
                });

                addDebugLog(`ç™»å½•APIçŠ¶æ€ç : ${loginResp.status}`, loginResp.ok ? 'success' : 'error');

                const loginData = await loginResp.json();
                addDebugLog(`ç™»å½•APIå“åº”: ${JSON.stringify(loginData)}`, loginResp.ok ? 'success' : 'error');

                if (!loginResp.ok || !loginData.success) {
                    throw new Error(loginData.error || 'ç™»å½•å¤±è´¥');
                }

                const token = loginData.data.token;
                addDebugLog(`âœ… Tokenè·å–æˆåŠŸï¼Œé•¿åº¦: ${token.length}`, 'success');

                // æ­¥éª¤2: éªŒè¯è¶…çº§ç®¡ç†å‘˜æƒé™ï¼ˆå°è¯•å¤šç§æ–¹å¼ï¼‰
                addDebugLog('æ­¥éª¤2: éªŒè¯è¶…çº§ç®¡ç†å‘˜æƒé™', 'info');

                let verifySuccess = false;
                let verifyData = null;
                let verifyError = '';

                // æ–¹å¼1: Authorization header
                try {
                    addDebugLog('å°è¯•æ–¹å¼1: Authorization header', 'info');
                    const resp1 = await fetch('/api/admin/superadmin/verify', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + token,
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });
                    const data1 = await resp1.json();
                    addDebugLog(`æ–¹å¼1å“åº”: ${JSON.stringify(data1)}`, resp1.ok && data1.success ? 'success' : 'error');
                    if (data1.success) {
                        verifySuccess = true;
                        verifyData = data1;
                        addDebugLog('âœ… æ–¹å¼1éªŒè¯æˆåŠŸ', 'success');
                    } else {
                        verifyError = data1.error || 'æœªçŸ¥é”™è¯¯';
                        addDebugLog(`âŒ æ–¹å¼1å¤±è´¥: ${verifyError}`, 'error');
                    }
                } catch (e) {
                    addDebugLog(`âŒ æ–¹å¼1å¼‚å¸¸: ${e.message}`, 'error');
                    verifyError = e.message;
                }

                // æ–¹å¼2: X-Auth-Token header
                if (!verifySuccess) {
                    try {
                        addDebugLog('å°è¯•æ–¹å¼2: X-Auth-Token header', 'info');
                        const resp2 = await fetch('/api/admin/superadmin/verify', {
                            method: 'POST',
                            headers: {
                                'X-Auth-Token': token,
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include'
                        });
                        const data2 = await resp2.json();
                        addDebugLog(`æ–¹å¼2å“åº”: ${JSON.stringify(data2)}`, resp2.ok && data2.success ? 'success' : 'error');
                        if (data2.success) {
                            verifySuccess = true;
                            verifyData = data2;
                            addDebugLog('âœ… æ–¹å¼2éªŒè¯æˆåŠŸ', 'success');
                        } else {
                            verifyError = data2.error || 'æœªçŸ¥é”™è¯¯';
                            addDebugLog(`âŒ æ–¹å¼2å¤±è´¥: ${verifyError}`, 'error');
                        }
                    } catch (e) {
                        addDebugLog(`âŒ æ–¹å¼2å¼‚å¸¸: ${e.message}`, 'error');
                        verifyError = e.message;
                    }
                }

                // æ–¹å¼3: bodyå‚æ•°
                if (!verifySuccess) {
                    try {
                        addDebugLog('å°è¯•æ–¹å¼3: bodyå‚æ•°', 'info');
                        const resp3 = await fetch('/api/admin/superadmin/verify', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include',
                            body: JSON.stringify({ token })
                        });
                        const data3 = await resp3.json();
                        addDebugLog(`æ–¹å¼3å“åº”: ${JSON.stringify(data3)}`, resp3.ok && data3.success ? 'success' : 'error');
                        if (data3.success) {
                            verifySuccess = true;
                            verifyData = data3;
                            addDebugLog('âœ… æ–¹å¼3éªŒè¯æˆåŠŸ', 'success');
                        } else {
                            verifyError = data3.error || 'æœªçŸ¥é”™è¯¯';
                            addDebugLog(`âŒ æ–¹å¼3å¤±è´¥: ${verifyError}`, 'error');
                        }
                    } catch (e) {
                        addDebugLog(`âŒ æ–¹å¼3å¼‚å¸¸: ${e.message}`, 'error');
                        verifyError = e.message;
                    }
                }

                if (!verifySuccess) {
                    throw new Error('æ‰€æœ‰éªŒè¯æ–¹å¼å‡å¤±è´¥: ' + verifyError);
                }

                addDebugLog('âœ… è¶…çº§ç®¡ç†å‘˜éªŒè¯é€šè¿‡', 'success');

                // æ­¥éª¤3: ä¿å­˜token
                addDebugLog('æ­¥éª¤3: ä¿å­˜tokenåˆ°æœ¬åœ°å­˜å‚¨', 'info');

                try {
                    localStorage.setItem('admin_token', token);
                    localStorage.setItem('admin_info', JSON.stringify(verifyData.admin));
                    addDebugLog('âœ… Tokenå·²ä¿å­˜åˆ°localStorage', 'success');
                } catch (e) {
                    addDebugLog(`âš ï¸ ä¿å­˜åˆ°localStorageå¤±è´¥: ${e.message}`, 'error');
                }

                try {
                    sessionStorage.setItem('admin_token', token);
                    sessionStorage.setItem('admin_info', JSON.stringify(verifyData.admin));
                    addDebugLog('âœ… Tokenå·²ä¿å­˜åˆ°sessionStorage', 'success');
                } catch (e) {
                    addDebugLog(`âš ï¸ ä¿å­˜åˆ°sessionStorageå¤±è´¥: ${e.message}`, 'error');
                }

                // æ­¥éª¤4: è·³è½¬
                addDebugLog('æ­¥éª¤4: è·³è½¬åˆ°ç®¡ç†åå°', 'info');
                showAlert('ç™»å½•æˆåŠŸï¼æ­£åœ¨è·³è½¬...', 'success');

                setTimeout(() => {
                    window.location.href = '/admin/dashboard';
                }, 500);

            } catch (error) {
                addDebugLog(`âŒ ç™»å½•å¤±è´¥: ${error.message}`, 'error');
                showAlert(error.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                throw error;
            }
        }

        // è¡¨å•æäº¤
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            const btn = document.getElementById('loginBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>ç™»å½•ä¸­...';

            try {
                await handleLogin(email, password);
            } catch (error) {
                // Error already handled
            } finally {
                btn.disabled = false;
                btn.textContent = 'ç™»å½•';
            }
        });

        // ä¸€é”®ç™»å½•æŒ‰é’®
        document.getElementById('autoLoginBtn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showAlert('è¯·å…ˆè¾“å…¥é‚®ç®±å’Œå¯†ç ', 'error');
                return;
            }

            const btn = document.getElementById('autoLoginBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>ç™»å½•ä¸­...';

            try {
                await handleLogin(email, password);
            } catch (error) {
                // Error already handled
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸš€ ä¸€é”®ç™»å½•ï¼ˆè‡ªåŠ¨å°è¯•æ‰€æœ‰æ–¹å¼ï¼‰';
            }
        });

        // ç”Ÿæˆè„šæœ¬æŒ‰é’®
        document.getElementById('scriptBtn').addEventListener('click', () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showAlert('è¯·å…ˆè¾“å…¥é‚®ç®±å’Œå¯†ç ', 'error');
                return;
            }

            const script = generateLoginScript(email, password);
            document.getElementById('scriptCode').textContent = script;
            document.getElementById('scriptModal').classList.add('active');
        });

        // å…³é—­æ¨¡æ€æ¡†
        function closeScriptModal() {
            document.getElementById('scriptModal').classList.remove('active');
        }

        // å¤åˆ¶è„šæœ¬
        function copyScript() {
            const script = document.getElementById('scriptCode').textContent;
            navigator.clipboard.writeText(script).then(() => {
                alert('è„šæœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(err => {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = script;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('è„šæœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            });
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('scriptModal').addEventListener('click', (e) => {
            if (e.target.id === 'scriptModal') {
                closeScriptModal();
            }
        });

        // ç”Ÿæˆç™»å½•è„šæœ¬
        function generateLoginScript(email, password) {
            return `(async function() {
    console.log('=== å¼€å§‹è‡ªåŠ¨ç™»å½• ===');
    console.log('é‚®ç®±:', '${email}');

    try {
        // æ­¥éª¤1: è°ƒç”¨ç™»å½•API
        console.log('æ­¥éª¤1: è°ƒç”¨ç™»å½•API...');
        const loginResp = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: '${email}',
                password: '${password}'
            }),
            credentials: 'include'
        });

        const loginData = await loginResp.json();
        console.log('ç™»å½•APIå“åº”:', loginData);

        if (!loginData.success) {
            throw new Error('ç™»å½•å¤±è´¥: ' + (loginData.error || 'æœªçŸ¥é”™è¯¯'));
        }

        const token = loginData.data.token;
        console.log('âœ… Tokenè·å–æˆåŠŸï¼Œé•¿åº¦:', token.length);

        // æ­¥éª¤2: éªŒè¯è¶…çº§ç®¡ç†å‘˜æƒé™ï¼ˆå°è¯•å¤šç§æ–¹å¼ï¼‰
        console.log('æ­¥éª¤2: éªŒè¯è¶…çº§ç®¡ç†å‘˜æƒé™...');

        let verifySuccess = false;
        let verifyData = null;
        let verifyError = '';

        // æ–¹å¼1: Authorization header
        try {
            console.log('å°è¯•æ–¹å¼1: Authorization header');
            const resp1 = await fetch('/api/admin/superadmin/verify', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });
            const data1 = await resp1.json();
            console.log('æ–¹å¼1å“åº”:', data1);
            if (data1.success) {
                verifySuccess = true;
                verifyData = data1;
                console.log('âœ… æ–¹å¼1éªŒè¯æˆåŠŸ');
            } else {
                verifyError = data1.error || 'æœªçŸ¥é”™è¯¯';
                console.log('âŒ æ–¹å¼1å¤±è´¥:', verifyError);
            }
        } catch (e) {
            console.log('âŒ æ–¹å¼1å¼‚å¸¸:', e.message);
            verifyError = e.message;
        }

        // æ–¹å¼2: X-Auth-Token header
        if (!verifySuccess) {
            try {
                console.log('å°è¯•æ–¹å¼2: X-Auth-Token header');
                const resp2 = await fetch('/api/admin/superadmin/verify', {
                    method: 'POST',
                    headers: {
                        'X-Auth-Token': token,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                const data2 = await resp2.json();
                console.log('æ–¹å¼2å“åº”:', data2);
                if (data2.success) {
                    verifySuccess = true;
                    verifyData = data2;
                    console.log('âœ… æ–¹å¼2éªŒè¯æˆåŠŸ');
                } else {
                    verifyError = data2.error || 'æœªçŸ¥é”™è¯¯';
                    console.log('âŒ æ–¹å¼2å¤±è´¥:', verifyError);
                }
            } catch (e) {
                console.log('âŒ æ–¹å¼2å¼‚å¸¸:', e.message);
                verifyError = e.message;
            }
        }

        // æ–¹å¼3: bodyå‚æ•°
        if (!verifySuccess) {
            try {
                console.log('å°è¯•æ–¹å¼3: bodyå‚æ•°');
                const resp3 = await fetch('/api/admin/superadmin/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ token })
                });
                const data3 = await resp3.json();
                console.log('æ–¹å¼3å“åº”:', data3);
                if (data3.success) {
                    verifySuccess = true;
                    verifyData = data3;
                    console.log('âœ… æ–¹å¼3éªŒè¯æˆåŠŸ');
                } else {
                    verifyError = data3.error || 'æœªçŸ¥é”™è¯¯';
                    console.log('âŒ æ–¹å¼3å¤±è´¥:', verifyError);
                }
            } catch (e) {
                console.log('âŒ æ–¹å¼3å¼‚å¸¸:', e.message);
                verifyError = e.message;
            }
        }

        if (!verifySuccess) {
            throw new Error('æ‰€æœ‰éªŒè¯æ–¹å¼å‡å¤±è´¥: ' + verifyError);
        }

        console.log('âœ… è¶…çº§ç®¡ç†å‘˜éªŒè¯é€šè¿‡');

        // æ­¥éª¤3: ä¿å­˜token
        console.log('æ­¥éª¤3: ä¿å­˜token...');
        try {
            localStorage.setItem('admin_token', token);
            localStorage.setItem('admin_info', JSON.stringify(verifyData.admin));
            console.log('âœ… Tokenå·²ä¿å­˜åˆ°localStorage');
        } catch (e) {
            console.warn('ä¿å­˜åˆ°localStorageå¤±è´¥:', e.message);
        }

        try {
            sessionStorage.setItem('admin_token', token);
            sessionStorage.setItem('admin_info', JSON.stringify(verifyData.admin));
            console.log('âœ… Tokenå·²ä¿å­˜åˆ°sessionStorage');
        } catch (e) {
            console.warn('ä¿å­˜åˆ°sessionStorageå¤±è´¥:', e.message);
        }

        // æ­¥éª¤4: è·³è½¬
        console.log('æ­¥éª¤4: è·³è½¬åˆ°ç®¡ç†åå°...');
        setTimeout(() => {
            window.location.href = '/admin/dashboard';
        }, 500);

    } catch (e) {
        console.error('âŒ è‡ªåŠ¨ç™»å½•å¤±è´¥:', e);
        alert('ç™»å½•å¤±è´¥: ' + e.message + '\\n\\nè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦ç»†ä¿¡æ¯');
    }
})();`;
        }
    </script>
</body>
</html>
