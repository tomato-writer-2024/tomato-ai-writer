# 番茄小说AI写作工具 - 常见问题解答

> **遇到问题？先看这里！**

---

## 目录

- [环境配置问题](#环境配置问题)
- [数据库问题](#数据库问题)
- [AI功能问题](#ai功能问题)
- [邮件服务问题](#邮件服务问题)
- [文件上传问题](#文件上传问题)
- [部署问题](#部署问题)
- [性能优化问题](#性能优化问题)
- [其他问题](#其他问题)

---

## 环境配置问题

### Q1：提示 "Cannot find module" 错误

**错误信息**：
```
Error: Cannot find module '@types/node'
```

**原因**：依赖包未正确安装

**解决方案**：

```bash
# 重新安装所有依赖
pnpm install

# 如果还是报错，删除node_modules后重新安装
rm -rf node_modules
pnpm install
```

---

### Q2：提示 "DATABASE_URL not found" 错误

**错误信息**：
```
Error: DATABASE_URL environment variable not found
```

**原因**：环境变量未配置

**解决方案**：

1. 检查 `.env.local` 文件是否存在
2. 确认 `DATABASE_URL` 已正确配置
3. 重启应用

```bash
# 检查.env.local文件
cat .env.local

# 重启应用
pnpm run dev
```

---

### Q3：JWT密钥错误

**错误信息**：
```
Error: jwt secret is too short
```

**原因**：JWT密钥长度不够

**解决方案**：

JWT密钥必须至少32位字符。

访问 https://www.uuidgenerator.net/api/guid 生成随机字符串，然后修改 `.env.local`：

```env
JWT_SECRET=550e8400-e29b-41d4-a716-446655440000
JWT_REFRESH_SECRET=660e8400-e29b-41d4-a716-446655440000
```

---

## 数据库问题

### Q4：数据库连接失败

**错误信息**：
```
Error: connect ECONNREFUSED localhost:5432
```

**原因**：数据库服务未启动或连接字符串错误

**解决方案**：

1. 检查数据库服务是否启动
2. 检查 `DATABASE_URL` 格式是否正确
3. 检查网络连接

```env
# 正确的DATABASE_URL格式
DATABASE_URL=postgresql://username:password@host:port/database_name

# 示例
DATABASE_URL=postgresql://postgres:password@localhost:5432/tomato_ai
```

---

### Q5：数据库表不存在

**错误信息**：
```
Error: relation "users" does not exist
```

**原因**：未执行数据库迁移

**解决方案**：

```bash
# 执行数据库迁移
pnpm run migrate

# 查看迁移结果
```

---

### Q6：数据库权限不足

**错误信息**：
```
Error: permission denied for table users
```

**原因**：数据库用户没有足够的权限

**解决方案**：

1. 使用具有足够权限的数据库用户
2. 或在PostgreSQL中授予权限：

```sql
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO your_user;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO your_user;
```

---

### Q7：数据库连接池耗尽

**错误信息**：
```
Error: sorry, too many clients already
```

**原因**：连接数超过数据库限制

**解决方案**：

1. 在代码中优化数据库连接，使用连接池
2. 增加数据库的最大连接数配置
3. 检查是否有连接未正确释放

---

## AI功能问题

### Q8：豆包AI没有响应

**错误信息**：
```
Error: Request failed with status code 401
```

**原因**：API Key错误或失效

**解决方案**：

1. 检查 `DOUBAO_API_KEY` 是否正确
2. 登录火山引擎控制台检查API Key是否有效
3. 检查账户是否有余额

```env
# 检查API Key格式（应以ak-开头）
DOUBAO_API_KEY=ak-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

---

### Q9：AI响应速度慢

**症状**：生成内容需要等待很长时间

**原因**：
- 模型选择不合适
- 网络延迟
- 生成内容过长

**解决方案**：

1. 使用更快的模型（如 `doubao-lite-4k`）

```env
DOUBAO_MODEL=doubao-lite-4k
```

2. 减少单次生成的内容长度
3. 使用流式输出（项目已默认支持）
4. 检查网络连接

---

### Q10：AI生成内容质量不高

**症状**：生成的内容不符合预期

**原因**：
- 提示词不够清晰
- 模型参数配置不合理
- 题材类型不适合

**解决方案**：

1. 优化提示词，提供更详细的信息
   - 故事背景
   - 角色设定
   - 目标和冲突
   - 风格要求

2. 调整模型参数
   - Temperature（创造性）：0.7-1.0
   - Top P（多样性）：0.9
   - Max Tokens（长度）：根据需求调整

3. 尝试不同的模型
   - Pro版（质量更高）
   - Lite版（速度更快）

---

### Q11：AI生成内容为空

**症状**：点击生成后没有返回任何内容

**原因**：
- API请求失败
- 生成内容被过滤
- 超时

**解决方案**：

1. 查看浏览器控制台错误信息
2. 检查API调用日志
3. 增加超时时间配置
4. 检查内容是否触发了敏感词过滤

---

## 邮件服务问题

### Q12：邮件发送失败

**错误信息**：
```
Error: Invalid login
```

**原因**：
- 邮箱配置错误
- 使用了登录密码而非授权码
- SMTP服务未开启

**解决方案**：

1. 检查邮箱配置

```env
EMAIL_HOST=smtp.163.com
EMAIL_PORT=465
EMAIL_SECURE=true
EMAIL_USER=your_email@163.com
EMAIL_PASS=your_email_authorization_code_here  # 必须是授权码
```

2. 确认使用的是授权码（不是登录密码）
3. 确认邮箱已开启SMTP服务

---

### Q13：无法收到验证邮件

**症状**：注册后收不到验证邮件

**原因**：
- 邮件进入垃圾箱
- 邮件发送失败
- Mock模式开启

**解决方案**：

1. 检查垃圾邮件文件夹
2. 检查邮件服务配置
3. 确认 `EMAIL_MOCK_MODE=false`

```env
# Mock模式下邮件不会实际发送
EMAIL_MOCK_MODE=false
```

4. 查看服务器日志，确认邮件发送状态

---

### Q14：SMTP连接超时

**错误信息**：
```
Error: Connection timeout
```

**原因**：
- SMTP地址或端口错误
- 网络问题
- 防火墙阻止

**解决方案**：

1. 检查SMTP配置

```env
# 163邮箱
EMAIL_HOST=smtp.163.com
EMAIL_PORT=465

# QQ邮箱
EMAIL_HOST=smtp.qq.com
EMAIL_PORT=465

# Gmail
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
```

2. 检查网络连接
3. 检查防火墙设置
4. 尝试使用不同的SMTP服务

---

## 文件上传问题

### Q15：文件上传失败

**错误信息**：
```
Error: File size exceeds limit
```

**原因**：文件大小超过限制

**解决方案**：

修改 `.env.local` 中的配置：

```env
# 最大文件上传大小（字节），10MB = 10485760
MAX_FILE_SIZE=10485760

# 如需支持更大的文件，可以修改为（20MB = 20971520）
MAX_FILE_SIZE=20971520
```

---

### Q16：文件格式不支持

**错误信息**：
```
Error: File type not allowed
```

**原因**：文件格式不在允许列表中

**解决方案**：

修改 `.env.local` 中的配置：

```env
# 允许的文件类型（逗号分隔）
ALLOWED_FILE_TYPES=image/jpeg,image/png,image/gif,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document,text/plain
```

支持的格式：
- 图片：`image/jpeg`, `image/png`, `image/gif`
- PDF：`application/pdf`
- Word：`application/vnd.openxmlformats-officedocument.wordprocessingml.document`
- TXT：`text/plain`

---

### Q17：文件下载失败

**症状**：点击下载后没有反应

**原因**：
- 文件不存在
- 下载链接错误
- 浏览器阻止

**解决方案**：

1. 检查文件是否存在
2. 查看浏览器控制台错误信息
3. 检查对象存储配置
4. 尝试使用不同的浏览器

---

## 部署问题

### Q18：部署后无法访问

**症状**：部署成功，但访问域名404或500错误

**原因**：
- 域名解析未生效
- 环境变量未正确配置
- 数据库未连接

**解决方案**：

1. 检查域名DNS解析是否生效
2. 检查所有环境变量是否正确配置
3. 检查数据库连接是否正常
4. 查看部署日志，定位错误

---

### Q19：环境变量未生效

**症状**：修改环境变量后，功能未更新

**原因**：
- 环境变量未正确设置
- 应用未重启

**解决方案**：

1. 确认环境变量已正确配置
2. 重新部署应用
3. 清除浏览器缓存
4. 等待几分钟让配置生效

---

### Q20：HTTPS证书错误

**错误信息**：
```
Error: unable to verify the first certificate
```

**原因**：HTTPS证书配置问题

**解决方案**：

1. 等待证书申请完成（通常需要5-10分钟）
2. 检查域名DNS解析是否正确
3. 确认域名已指向正确的服务器
4. 检查证书有效期

---

### Q21：部署后数据库连接失败

**症状**：本地正常，部署后无法连接数据库

**原因**：
- 数据库只允许本地连接
- 防火墙阻止远程连接
- 连接字符串配置错误

**解决方案**：

1. 确认数据库允许远程连接
2. 检查数据库防火墙设置
3. 确认 `DATABASE_URL` 配置正确
4. 使用支持远程连接的数据库服务（如Supabase、Railway）

---

## 性能优化问题

### Q22：页面加载慢

**症状**：访问网站需要等待很长时间

**原因**：
- 首屏加载内容过多
- 图片过大
- 未使用CDN

**解决方案**：

1. 优化首屏加载
   - 使用代码分割
   - 懒加载组件
   - 预加载关键资源

2. 优化图片
   - 压缩图片大小
   - 使用WebP格式
   - 响应式图片

3. 使用CDN加速
   - Vercel/Railway自带CDN
   - 配置自定义CDN

---

### Q23：AI首字响应慢

**症状**：点击生成后，需要等待很久才开始输出

**原因**：
- API请求建立连接慢
- 模型加载时间长
- 网络延迟

**解决方案**：

1. 使用流式输出（项目已默认支持）
2. 选择响应更快的模型（如 `doubao-lite-4k`）
3. 优化网络连接
4. 使用离用户近的服务器

---

### Q24：数据库查询慢

**症状**：页面加载时数据库查询很慢

**原因**：
- 缺少索引
- 查询语句未优化
- 数据量过大

**解决方案**：

1. 添加数据库索引

```sql
CREATE INDEX idx_novels_user_id ON novels(user_id);
CREATE INDEX idx_chapters_novel_id ON chapters(novel_id);
```

2. 优化查询语句
   - 只查询需要的字段
   - 使用LIMIT限制返回数量
   - 避免N+1查询

3. 使用缓存
   - Redis缓存热门数据
   - 内存缓存常用查询

---

## 其他问题

### Q25：用户注册后无法登录

**症状**：注册成功后，使用相同账号密码无法登录

**原因**：
- 密码错误
- 邮箱未验证
- 数据库记录异常

**解决方案**：

1. 确认用户名和密码正确
2. 检查是否完成了邮箱验证（如果配置了邮件服务）
3. 检查数据库用户记录
4. 使用超级管理员账号重置密码

---

### Q26：忘记管理员密码

**症状**：无法使用管理员账号登录

**解决方案**：

**方法1：重新初始化管理员**

```bash
# 这会重新创建管理员账号（旧账号会被覆盖）
pnpm run init-admin
```

**方法2：直接修改数据库**

```sql
# 连接数据库
psql $DATABASE_URL

# 更新管理员密码（password需要是bcrypt加密后的）
UPDATE users SET password = '$2a$10$encrypted_password' WHERE username = 'admin';
```

**方法3：使用密码重置功能**

1. 在登录页面点击"忘记密码"
2. 输入管理员邮箱
3. 检查邮箱并重置密码

---

### Q27：双视角评分不准确

**症状**：AI评分结果与实际预期差距较大

**原因**：
- 评分模型参数未优化
- 评分标准不明确
- AI理解偏差

**解决方案**：

1. 提供更详细的评分标准
2. 调整评分模型的参数
3. 提供示例作品供AI参考
4. 人工审核和修正AI评分

---

### Q28：导入文件内容乱码

**症状**：导入Word或PDF文件后，内容显示乱码

**原因**：
- 文件编码问题
- 文件格式不支持
- 解析器错误

**解决方案**：

1. 确保文件使用UTF-8编码保存
2. 尝试转换为TXT格式再导入
3. 检查文件是否损坏
4. 使用不同的文件格式

---

### Q29：导出文件格式错误

**症状**：导出的PDF或Word文件格式错乱

**原因**：
- 内容格式问题
- 生成库配置错误
- 特殊字符处理不当

**解决方案**：

1. 简化内容格式（去除复杂样式）
2. 检查特殊字符是否正确转义
3. 尝试不同的导出格式
4. 更新导出库版本

---

### Q30：如何备份和恢复数据？

**备份策略**：

1. **数据库备份**

```bash
# 使用pg_dump备份PostgreSQL数据库
pg_dump $DATABASE_URL > backup.sql

# 恢复数据库
psql $DATABASE_URL < backup.sql
```

2. **对象存储备份**
   - 定期下载重要文件到本地
   - 使用对象存储的版本控制功能

3. **环境变量备份**
   - 保存 `.env.local` 文件到安全位置
   - 使用密码管理工具存储敏感信息

**自动化备份**：

```bash
# 创建备份脚本
cat > backup.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
pg_dump $DATABASE_URL > backups/db_$DATE.sql
EOF

chmod +x backup.sh

# 添加到定时任务（每天凌晨2点备份）
crontab -e
0 2 * * * /path/to/backup.sh
```

---

## 获取更多帮助

如果在文档中没有找到解决方案，可以：

1. **查看日志**
   - 浏览器控制台（F12）
   - 服务器日志
   - 部署平台日志

2. **搜索错误信息**
   - 使用Google搜索错误信息
   - 查看GitHub Issues

3. **联系技术支持**
   - 提供详细的错误信息
   - 说明复现步骤
   - 附上相关日志

---

## 贡献答案

如果你解决了新的问题，欢迎将解决方案添加到本文档！

---

**文档版本**：v1.0
**最后更新**：2025年
